name: Flutter CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  analyze-and-test:
    name: Analyze and Test
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: 'stable'

    - name: Install dependencies
      run: flutter pub get

    - name: Prevent committed .env
      run: |
        if [ -f .env ]; then
          echo "ERROR: .env file found in the repository. This file should not be committed."; exit 1
        fi

    - name: Analyze
      run: flutter analyze

    - name: Run tests
      run: flutter test --coverage
  build-debug-apk:
    name: Build debug APK (PR validation)
    runs-on: ubuntu-latest
    needs: analyze-and-test
    if: github.event_name == 'pull_request'

    steps:
    - uses: actions/checkout@v4

    - name: Set up Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: 'stable'

    - name: Install dependencies
      run: flutter pub get

    - name: Build debug APK
      run: flutter build apk --debug --no-shrink

    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: debug-apk
        path: build/app/outputs/flutter-apk/app-debug.apk
  release-build:
    name: Release build (AAB/APK)
    runs-on: ubuntu-latest
    needs: analyze-and-test
    if: github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/main'

    steps:
    - uses: actions/checkout@v4

    - name: Set up Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: 'stable'

    - name: Create .env from secrets
      run: |
        printf "ADDIS_AI_API_KEY=%s\nBASE_URL=%s\n" "${{ secrets.ADDIS_AI_API_KEY }}" "${{ secrets.BASE_URL }}" > .env
      env:
        BASE_URL: ${{ secrets.BASE_URL }}

    - name: Decode keystore
      env:
        KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
      if: env.KEYSTORE_BASE64 != ''
      run: |
        mkdir -p android
        echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > android/app/upload-keystore.jks

    - name: Create android/key.properties
      env:
        PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
      if: env.PASSWORD != ''
      run: |
        printf "storePassword=%s\nkeyPassword=%s\nkeyAlias=%s\nstoreFile=android/app/upload-keystore.jks\n" "${{ secrets.KEYSTORE_PASSWORD }}" "${{ secrets.KEY_PASSWORD }}" "${{ secrets.KEY_ALIAS }}" > android/key.properties

    - name: Install dependencies
      run: flutter pub get

    - name: Build app bundle
      run: flutter build appbundle --release --no-shrink

    - name: Upload release artifact
      uses: actions/upload-artifact@v4
      with:
        name: release-aab
        path: build/app/outputs/bundle/release/app-release.aab
