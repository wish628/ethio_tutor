#!/bin/sh
# Pre-commit hook that prevents committing a .env file and other accidental secrets.

STAGED_FILES=$(git diff --cached --name-only)

if echo "$STAGED_FILES" | grep -q "^\.env$"; then
  echo "ERROR: You are trying to commit .env. Please keep secrets out of the repo. Use .env.example instead." >&2
  exit 1
fi

# Optionally check for common secret patterns (simple heuristic)
if echo "$STAGED_FILES" | grep -E "(\.env|\.keystore|key.properties|android/key.properties)"; then
  echo "Checking staged files for accidental secrets..."
fi

# If Flutter is available, run a quick analyze and tests to catch issues early.
if command -v flutter >/dev/null 2>&1; then
  echo "Running flutter analyze..."
  flutter analyze || { echo "flutter analyze failed. Fix issues before committing." >&2; exit 1; }

  echo "Running flutter test..."
  flutter test || { echo "flutter test failed. Fix failing tests before committing." >&2; exit 1; }
else
  echo "flutter not found in PATH; skipping analyze/test. It's recommended to run them locally before committing." >&2
fi

exit 0
